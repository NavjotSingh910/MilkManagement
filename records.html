<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Milk Selling Platform - Sales Records</title>
    <link rel="stylesheet" href="styles.css" />
    <!-- Include Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      /* Global styles */
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
        background-color: #f4f4f4;
        color: #333;
      }

      .wrapper {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }

      header,
      footer {
        background-color: #333;
        color: #fff;
        padding: 1rem;
        text-align: center;
      }

      nav {
        display: flex;
        justify-content: center;
        background-color: #444;
      }

      nav a {
        color: #fff;
        padding: 1rem;
        text-decoration: none;
      }

      nav a:hover {
        background-color: #555;
      }

      section {
        padding: 2rem;
        margin: 1rem auto;
        max-width: 800px;
        background-color: #fff;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }

      h2 {
        text-align: center;
        color: #333;
      }

      .sales-data table {
        width: 100%;
        border-collapse: collapse;
      }

      .sales-data th,
      .sales-data td {
        padding: 8px;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }

      .sales-data th {
        background-color: #f2f2f2;
        color: #333;
      }

      .sales-chart {
        text-align: center;
      }

      .sales-chart canvas {
        max-width: 100%;
        margin: auto;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        border-radius: 5px;
      }
    </style>
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>Milk Selling Platform</h1>
      </header>
      <nav>
        <a href="index.html">Home</a>
        <a href="#">Buy Milk</a>
        <a href="sell.html">Sell Milk</a>
        <a href="#">Records</a>
        <a href="#">Logout</a>
      </nav>
      <section class="sales-data">
        <h2>Sales Records</h2>
        <table id="salesTable">
          <thead>
            <tr>
              <th>Transaction ID</th>
              <th>Buyer ID</th>
              <th>Buyer Name</th>
              <th>Quantity (liters)</th>
              <th>Payment Method</th>
              <th>Milk Type</th>
              <th>Shift</th>
              <th>Date</th>
              <th>Time</th>
            </tr>
          </thead>
          <tbody id="salesData">
            <!-- Sales data rows will be dynamically added here -->
          </tbody>
        </table>
      </section>
      <section class="sales-chart">
        <h2>Sales Chart</h2>
        <canvas id="salesChart" width="800" height="400"></canvas>
      </section>
      <footer>
        <p>&copy; 2024 Milk Selling Platform</p>
      </footer>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Constants for pagination
        const recordsPerPage = 10; // Number of records per page
        let currentPage = 1; // Current page index

        // Fetch sales data
        fetch("http://127.0.0.1:3000/getMilkSales")
          .then((response) => response.json())
          .then((data) => {
            // Display initial records and chart
            displaySalesData(data);
            renderSalesChart(data);
          })
          .catch((error) => {
            console.error("Error fetching data:", error);
            alert("Failed to fetch data. Please try again later.");
          });

        // Function to display sales data in table
        function displaySalesData(data) {
          const salesData = document.getElementById("salesData");
          salesData.innerHTML = ""; // Clear existing data

          const startIndex = (currentPage - 1) * recordsPerPage;
          const endIndex = startIndex + recordsPerPage;

          // Iterate over the subset of data for the current page
          for (let i = startIndex; i < endIndex && i < data.length; i++) {
            const sale = data[i];
            const row = document.createElement("tr");
            const transactionDate = new Date(sale.transactionDate);

            // Format date and time separately
            const formattedDate = transactionDate.toLocaleDateString("en-US");
            const formattedTime = transactionDate.toLocaleTimeString("en-US");

            row.innerHTML = `
                <td>${sale.transactionId}</td>
                <td>${sale.buyerId}</td>
                <td>${sale.buyerName}</td>
                <td>${sale.quantity}</td>
                <td>${sale.paymentMethod}</td>
                <td>${sale.milkType}</td>
                <td>${sale.shift}</td>
                <td>${formattedDate}</td>
                <td>${formattedTime}</td>
            `;

            salesData.appendChild(row);
          }

          // Display pagination controls if needed
          if (data.length > recordsPerPage) {
            displayPaginationControls(data.length);
          }
        }

        // Function to display pagination controls
        function displayPaginationControls(totalRecords) {
          const totalPages = Math.ceil(totalRecords / recordsPerPage);

          let paginationHTML = `
            <div class="pagination">
                <button class="prev-btn" ${
                  currentPage === 1 ? "disabled" : ""
                }>Prev</button>
                <span>Page ${currentPage} of ${totalPages}</span>
                <button class="next-btn" ${
                  currentPage === totalPages ? "disabled" : ""
                }>Next</button>
            </div>
        `;

          // Insert pagination controls after the sales data table
          const salesSection = document.querySelector(".sales-data");
          const paginationContainer = document.createElement("div");
          paginationContainer.innerHTML = paginationHTML;
          salesSection.appendChild(paginationContainer);

          // Event listeners for pagination buttons
          const prevBtn = document.querySelector(".prev-btn");
          const nextBtn = document.querySelector(".next-btn");

          prevBtn.addEventListener("click", () => {
            if (currentPage > 1) {
              currentPage--;
              displaySalesData(data);
            }
          });

          nextBtn.addEventListener("click", () => {
            if (currentPage < totalPages) {
              currentPage++;
              displaySalesData(data);
            }
          });
        }

        // Function to render sales chart
     // Function to render sales chart
function renderSalesChart(data) {
    // Extract labels (dates) and data (quantities) for chart
    const labels = data.map(sale => {
        const transactionDate = new Date(sale.transactionDate);
        return transactionDate.toLocaleDateString('en-US');
    });

    const quantities = data.map(sale => parseFloat(sale.quantity));

    // Get canvas element
    const ctx = document.getElementById('salesChart').getContext('2d');

    // Adjust chart height statically
    ctx.canvas.height = 300; // Adjust as needed

    // Create chart using Chart.js
    const chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Quantity Sold (liters)',
                data: quantities,
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: false, // Disable responsiveness to keep fixed height
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Quantity (liters)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Date'
                    }
                }
            }
        }
    });
}
 });
    </script>
  </body>
</html>
